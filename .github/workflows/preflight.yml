name: Preflight

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      max-concurrent:
        description: "Max concurrent Docker containers per shard"
        required: false
        default: "1"
      timeout:
        description: "Per-test timeout in seconds"
        required: false
        default: "600"

permissions:
  contents: write

jobs:
  preflight-typescript:
    name: "TypeScript"
    runs-on: ubuntu-latest
    timeout-minutes: 120
    steps:
      - uses: actions/checkout@v4

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Free disk space
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: false

      - name: Run preflight
        id: preflight
        uses: ./
        with:
          mode: preflight
          filter-category: typescript
          max-concurrent: ${{ inputs.max-concurrent || '1' }}
          timeout: ${{ inputs.timeout || '600' }}

      - name: Upload results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: preflight-typescript
          path: swe-bench-results/

  preflight-javascript:
    name: "JavaScript (${{ matrix.shard }})"
    runs-on: ubuntu-latest
    timeout-minutes: 120
    strategy:
      fail-fast: false
      matrix:
        shard: [0, 1, 2, 3]
    steps:
      - uses: actions/checkout@v4

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Free disk space
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: false

      - name: Run preflight
        id: preflight
        uses: ./
        with:
          mode: preflight
          filter-category: javascript
          max-concurrent: ${{ inputs.max-concurrent || '1' }}
          timeout: ${{ inputs.timeout || '600' }}
          shard-index: ${{ matrix.shard }}
          shard-total: "4"

      - name: Upload results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: preflight-javascript-${{ matrix.shard }}
          path: swe-bench-results/

  preflight-python:
    name: "Python (${{ matrix.shard }})"
    runs-on: ubuntu-latest
    timeout-minutes: 120
    strategy:
      fail-fast: false
      matrix:
        shard: [0, 1, 2, 3, 4, 5]
    steps:
      - uses: actions/checkout@v4

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Free disk space
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: false

      - name: Run preflight
        id: preflight
        uses: ./
        with:
          mode: preflight
          filter-category: python
          max-concurrent: ${{ inputs.max-concurrent || '1' }}
          timeout: ${{ inputs.timeout || '600' }}
          shard-index: ${{ matrix.shard }}
          shard-total: "6"

      - name: Upload results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: preflight-python-${{ matrix.shard }}
          path: swe-bench-results/

  preflight-go:
    name: "Go (${{ matrix.shard }})"
    runs-on: ubuntu-latest
    timeout-minutes: 120
    strategy:
      fail-fast: false
      matrix:
        shard: [0, 1, 2, 3, 4, 5]
    steps:
      - uses: actions/checkout@v4

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Free disk space
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: false

      - name: Run preflight
        id: preflight
        uses: ./
        with:
          mode: preflight
          filter-category: go
          max-concurrent: ${{ inputs.max-concurrent || '1' }}
          timeout: ${{ inputs.timeout || '600' }}
          shard-index: ${{ matrix.shard }}
          shard-total: "6"

      - name: Upload results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: preflight-go-${{ matrix.shard }}
          path: swe-bench-results/

  results:
    name: "Results"
    runs-on: ubuntu-latest
    needs: [preflight-typescript, preflight-javascript, preflight-python, preflight-go]
    if: always()
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: results/

      - name: Summarize results and update badge
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TOTAL_PASSED=0
          TOTAL_FAILED=0
          TOTAL_ERRORS=0

          echo "## Preflight Results" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "| Language | Shard | Passed | Failed | Errors | Total |" >> "$GITHUB_STEP_SUMMARY"
          echo "|----------|-------|--------|--------|--------|-------|" >> "$GITHUB_STEP_SUMMARY"

          for dir in results/preflight-*/; do
            [ -d "$dir" ] || continue
            name="$(basename "$dir")"

            if [ -f "$dir/output.log" ]; then
              passed=$(grep -c "^PASS" "$dir/output.log" 2>/dev/null || echo "0")
              failed=$(grep -c "^FAIL" "$dir/output.log" 2>/dev/null || echo "0")
              errors=$(grep -c "^ERROR" "$dir/output.log" 2>/dev/null || echo "0")
              passed="${passed//[^0-9]/}"; passed="${passed:-0}"
              failed="${failed//[^0-9]/}"; failed="${failed:-0}"
              errors="${errors//[^0-9]/}"; errors="${errors:-0}"
              total=$((passed + failed + errors))
              TOTAL_PASSED=$((TOTAL_PASSED + passed))
              TOTAL_FAILED=$((TOTAL_FAILED + failed))
              TOTAL_ERRORS=$((TOTAL_ERRORS + errors))
              echo "| ${name} | | ${passed} | ${failed} | ${errors} | ${total} |" >> "$GITHUB_STEP_SUMMARY"
            else
              echo "| ${name} | | - | - | - | no results |" >> "$GITHUB_STEP_SUMMARY"
            fi
          done

          GRAND_TOTAL=$((TOTAL_PASSED + TOTAL_FAILED + TOTAL_ERRORS))

          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "**Total: ${TOTAL_PASSED}/${GRAND_TOTAL} passing, ${TOTAL_FAILED} failed, ${TOTAL_ERRORS} errors**" >> "$GITHUB_STEP_SUMMARY"

          # Determine badge color and message
          if [ "$GRAND_TOTAL" -eq 0 ]; then
            COLOR="lightgrey"
            MESSAGE="no data"
          elif [ "$TOTAL_PASSED" -eq "$GRAND_TOTAL" ]; then
            COLOR="brightgreen"
            MESSAGE="${TOTAL_PASSED}/${GRAND_TOTAL} passing"
          elif [ "$TOTAL_PASSED" -gt 0 ]; then
            COLOR="yellow"
            MESSAGE="${TOTAL_PASSED}/${GRAND_TOTAL} passing"
          else
            COLOR="red"
            MESSAGE="0/${GRAND_TOTAL} passing"
          fi

          # Write shields.io endpoint badge JSON
          printf '{"schemaVersion":1,"label":"preflight","message":"%s","color":"%s"}\n' \
            "$MESSAGE" "$COLOR" > preflight-badge.json

          cat preflight-badge.json

          # Push badge JSON to the badges branch
          if [ "$GITHUB_REF" = "refs/heads/main" ]; then
            REPO_URL="https://x-access-token:${GITHUB_TOKEN}@github.com/${GITHUB_REPOSITORY}.git"
            git init badges-repo
            cd badges-repo
            git remote add origin "$REPO_URL"
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"

            if git fetch origin badges 2>/dev/null; then
              git checkout badges
            else
              git checkout --orphan badges
              git rm -rf . 2>/dev/null || true
            fi

            cp ../preflight-badge.json .
            git add preflight-badge.json
            git commit -m "preflight: ${MESSAGE}" --allow-empty
            git push origin badges --force
            cd ..
          fi

          # Fail the workflow if ANY instance failed or errored
          if [ "$TOTAL_FAILED" -gt 0 ] || [ "$TOTAL_ERRORS" -gt 0 ]; then
            echo "::error::${TOTAL_FAILED} failed, ${TOTAL_ERRORS} errors out of ${GRAND_TOTAL} instances."
            exit 1
          fi

          if [ "$GRAND_TOTAL" -eq 0 ]; then
            echo "::error::No preflight results found. Check that all language jobs produced output."
            exit 1
          fi

          echo "All ${GRAND_TOTAL} instances passed preflight."

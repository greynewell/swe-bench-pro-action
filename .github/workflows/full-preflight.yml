name: Full Preflight Validation

on:
  workflow_dispatch:
    inputs:
      max-concurrent:
        description: "Max concurrent Docker containers per job"
        required: false
        default: "4"
      timeout:
        description: "Per-test timeout in seconds"
        required: false
        default: "600"

jobs:
  preflight-python:
    name: "Preflight: Python"
    runs-on: ubuntu-latest
    timeout-minutes: 360
    steps:
      - uses: actions/checkout@v4

      - name: Free disk space
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: false

      - name: Run preflight (Python)
        id: preflight
        uses: ./
        with:
          mode: preflight
          filter-category: python
          max-concurrent: ${{ inputs.max-concurrent }}
          timeout: ${{ inputs.timeout }}

      - name: Upload results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: preflight-python
          path: swe-bench-results/

  preflight-go:
    name: "Preflight: Go"
    runs-on: ubuntu-latest
    timeout-minutes: 360
    steps:
      - uses: actions/checkout@v4

      - name: Free disk space
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: false

      - name: Run preflight (Go)
        id: preflight
        uses: ./
        with:
          mode: preflight
          filter-category: go
          max-concurrent: ${{ inputs.max-concurrent }}
          timeout: ${{ inputs.timeout }}

      - name: Upload results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: preflight-go
          path: swe-bench-results/

  preflight-typescript:
    name: "Preflight: TypeScript"
    runs-on: ubuntu-latest
    timeout-minutes: 360
    steps:
      - uses: actions/checkout@v4

      - name: Free disk space
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: false

      - name: Run preflight (TypeScript)
        id: preflight
        uses: ./
        with:
          mode: preflight
          filter-category: typescript
          max-concurrent: ${{ inputs.max-concurrent }}
          timeout: ${{ inputs.timeout }}

      - name: Upload results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: preflight-typescript
          path: swe-bench-results/

  preflight-javascript:
    name: "Preflight: JavaScript"
    runs-on: ubuntu-latest
    timeout-minutes: 360
    steps:
      - uses: actions/checkout@v4

      - name: Free disk space
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: false

      - name: Run preflight (JavaScript)
        id: preflight
        uses: ./
        with:
          mode: preflight
          filter-category: javascript
          max-concurrent: ${{ inputs.max-concurrent }}
          timeout: ${{ inputs.timeout }}

      - name: Upload results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: preflight-javascript
          path: swe-bench-results/

  summary:
    name: "Preflight Summary"
    runs-on: ubuntu-latest
    needs: [preflight-python, preflight-go, preflight-typescript, preflight-javascript]
    if: always()
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: results/

      - name: Summarize results
        run: |
          echo "## Full Preflight Results" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "| Language | Status |" >> "$GITHUB_STEP_SUMMARY"
          echo "|----------|--------|" >> "$GITHUB_STEP_SUMMARY"

          for lang in python go typescript javascript; do
            dir="results/preflight-${lang}"
            if [ -d "$dir" ]; then
              if [ -f "$dir/output.log" ]; then
                passed=$(grep -c "PASS" "$dir/output.log" 2>/dev/null || echo "0")
                failed=$(grep -c "FAIL" "$dir/output.log" 2>/dev/null || echo "0")
                total=$((passed + failed))
                echo "| ${lang} | ${passed}/${total} passed |" >> "$GITHUB_STEP_SUMMARY"
              else
                echo "| ${lang} | No output log found |" >> "$GITHUB_STEP_SUMMARY"
              fi
            else
              echo "| ${lang} | No results (job may have failed) |" >> "$GITHUB_STEP_SUMMARY"
            fi
          done

          echo "" >> "$GITHUB_STEP_SUMMARY"

          # Show combined logs
          echo "### Logs" >> "$GITHUB_STEP_SUMMARY"
          echo '```' >> "$GITHUB_STEP_SUMMARY"
          for lang in python go typescript javascript; do
            log="results/preflight-${lang}/output.log"
            if [ -f "$log" ]; then
              echo "=== ${lang} ===" >> "$GITHUB_STEP_SUMMARY"
              tail -20 "$log" >> "$GITHUB_STEP_SUMMARY"
              echo "" >> "$GITHUB_STEP_SUMMARY"
            fi
          done
          echo '```' >> "$GITHUB_STEP_SUMMARY"
